#!/usr/bin/python3
import socket
import struct
import sys
import argparse

def check_cve_2020_0796(ip="127.0.0.1", verbosity=0) :
    if ip == "127.0.0.1" :
        print("this is a test against your own system!")
    pkt = b'\x00\x00\x00\xc0\xfeSMB@\x00\x00\x00\x00\x00\x00\x00\x00\x00\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00$\x00\x08\x00\x01\x00\x00\x00\x7f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00x\x00\x00\x00\x02\x00\x00\x00\x02\x02\x10\x02"\x02$\x02\x00\x03\x02\x03\x10\x03\x11\x03\x00\x00\x00\x00\x01\x00&\x00\x00\x00\x00\x00\x01\x00 \x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00\n\x00\x00\x00\x00\x00\x01\x00\x00\x00\x01\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00'
    sock = socket.socket(socket.AF_INET)
    sock.settimeout(3)
    print(ip)
    fail = False
    try :
        sock.connect(( ip ,  445 ))
        sock.send(pkt)
    except :
        print("couldn't connect for some reason...")
        fail = True

    if fail :
        return ip + ": Not available"

    nb, = struct.unpack(">I", sock.recv(4))
    res = sock.recv(nb)

    if not res[68:70] == b"\x11\x03":
        print(ip + ":", "Not vulnerable.")
        return ip + ": Not vulnerable."
    if not res[70:72] == b"\x02\x00":
        print(ip + ":", "Not vulnerable.")

    print(ip + ":", "Vulnerable.")
    return(ip + ":", "Vulnerable.")

# get args
parser = argparse.ArgumentParser(description='A script that will check a list of servers for vulnerability to CVE-2020-0796'\
        ,epilog="If output files are not provided, output will be stdout")
parser.add_argument('input_file', help='a file with a list of IPs to scan for vulnerability')
parser.add_argument('--output', '-o', help='The output file to store vulnerable servers\' ip')
parser.add_argument('--verbose', '-v', action='count', default=0,\
        help='Add this arg if you want to save a full report, including not vulnerable servers')
parser.add_argument('--version', action='version', version='%(prog)s 0.1')
try :
    args = parser.parse_args(sys.argv[1:])
    debug = False
except:
    parser.add_argument('--debug', action='store_true', help=None)
    args = parser.parse_args(sys.argv[1:])
    debug = args.debug

input_file = args.input_file
output_file = args.output
verbosity = args.verbose
final_output=''
if debug :
    with open(input_file, "r") as ip_list :
        for line in ip_list:
            if len(line.strip()) == 0:
                continue
            final_output += line.strip() + ": Vulnerable.\n"
    if output_file != None :
        with open(output_file, "w") as outfile :
            outfile.write(final_output.strip())
    else :
        print(final_output)
    sys.exit(99999)
with open(input_file, "r") as ip_list :
    for line in ip_list :
        if len(line.strip()) == 0:
            continue
        response = check_cve_2020_0796(ip=line.strip(), verbosity=verbosity).strip() + "\n"
        final_output += response if ("Vulnerable." in response) or (verbosity > 0) else ""
if output_file==None :
    print(final_output)
else :
    with open(output_file) as outfile :
        outfile.write(final_output)
        print("output saved to", output_file)
# Credit: ollypwn
